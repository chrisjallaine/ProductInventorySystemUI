<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/inventory.css" />
</head>
<body>
  <header>
    <a href="index.html" class="back-link">‚Üê Dashboard</a>
    <h1>Inventory Management</h1>
  </header>

  <main>
    <!-- Search -->
    <section class="form-section">
      <h2>Search Inventory</h2>
      <form id="searchForm">
        <select id="searchType" required>
          <option value="">--Select Search Type--</option>
          <option value="product">Product Name</option>
          <option value="warehouse">Warehouse Name</option>
        </select>
        <input type="text" id="searchField" placeholder="Enter search value" style="display: none;" required />
        <button type="submit" style="display: none;">Search</button>
      </form>
      <ul id="searchResults"></ul>
    </section>

    <!-- Add -->
    <section class="form-section">
      <h2>Add Inventory</h2>
      <form id="addForm">
        <label for="productSelect">Product</label>
        <select id="productSelect" required>
          <option value="">Select a product</option>
        </select>

        <div class="info-fields">
          <label for="categoryField">Category</label>
          <input type="text" id="categoryField" readonly />

          <label for="supplierField">Supplier</label>
          <input type="text" id="supplierField" readonly />
        </div>

        <label for="warehouseSelect">Warehouse</label>
        <select id="warehouseSelect" required>
          <option value="">Select a warehouse</option>
        </select>

        <label for="stock">Stock Quantity</label>
        <input type="number" id="stock" required />

        <button type="submit">Add Inventory</button>
      </form>
    </section>

    <!-- Low Stock -->
    <section class="list-section">
      <h2>Low Stock Items</h2>
      <select id="lowStockWarehouse">
        <option value="">Select warehouse</option>
      </select>
      <button id="checkLowStock">Check Low Stock</button>
      <ul id="lowStockList"></ul>
    </section>

    <!-- All Inventory -->
    <section class="list-section">
      <h2>All Inventory</h2>
      <button id="viewAll">Load All Inventory</button>
      <ul id="allInventoryList"></ul>
    </section>
  </main>

  <script>
    const $ = id => document.getElementById(id)

    const api = async (url, method = 'GET', body) => {
      const res = await fetch(`http://localhost:5000/api/${url}`, {
        method,
        headers: body ? { 'Content-Type': 'application/json' } : {},
        body: body ? JSON.stringify(body) : undefined
      })
      if (!res.ok) throw new Error((await res.json()).message || 'Request failed')
      return res.json()
    }

    const productMap = new Map()
    const warehouseMap = new Map()

    const renderList = (data, targetId) => {
      $(targetId).innerHTML = data.map(i => `
        <li>
          <strong>${i.product_id?.name || 'Unknown'}</strong><br/>
          Category: ${i.category_id?.name || ''}<br/>
          Supplier: ${i.supplier_id?.name || ''}<br/>
          Stock: ${i.stock}<br/>
          Unit Price: ${i.unitPrice ? i.unitPrice.toFixed(2) : ''}<br/>
          Warehouse: ${i.warehouse_id?.location || ''}<br/>
          Last Updated: ${new Date(i.updatedAt || i.createdAt).toLocaleString()}<br/>
          <button onclick="updateInventoryPrompt('${i._id}', '${targetId}')">Update</button>
          <button onclick="deleteInventory('${i._id}', '${targetId}')">Delete</button>
        </li>
      `).join('')
    }

    const populateSelect = (selectId, data, textKey, mapRef) => {
      const select = $(selectId)
      data.forEach(item => {
        const opt = document.createElement('option')
        opt.value = item[textKey]
        opt.textContent = item[textKey]
        select.appendChild(opt)
        mapRef.set(item[textKey], item._id)
      })
    }

    const loadData = async () => {
      const products = await api('products')
      const warehouses = await api('warehouses')
      populateSelect('productSelect', products, 'name', productMap)
      populateSelect('warehouseSelect', warehouses, 'location', warehouseMap)
      populateSelect('lowStockWarehouse', warehouses, 'location', warehouseMap)
    }

    $('productSelect').onchange = async () => {
      const name = $('productSelect').value
      const id = productMap.get(name)
      if (!id) return
      const product = await api(`products/${id}`)
      $('categoryField').value = product.category_id?.name || ''
      $('supplierField').value = product.supplier_id?.name || ''
    }

    $('addForm').onsubmit = async e => {
      e.preventDefault()
      const productName = $('productSelect').value
      const warehouseName = $('warehouseSelect').value
      const stock = Number($('stock').value)

      if (!productName || !warehouseName || isNaN(stock) || stock < 0) {
        alert('All fields are required and stock must be a valid non-negative number.')
        return
      }

      const product_id = productMap.get(productName)
      const warehouse_id = warehouseMap.get(warehouseName)

      console.log({ product_id, warehouse_id, stock }) // Logging added here

      try {
        await api('inventory', 'POST', { product_id, warehouse_id, stock })
        alert('Inventory added.')
        $('addForm').reset()
        $('categoryField').value = ''
        $('supplierField').value = ''
      } catch (err) {
        alert('Failed to add inventory: ' + err.message)
      }
    }

    $('searchType').onchange = e => {
      const show = !!e.target.value
      $('searchField').style.display = show ? 'inline' : 'none'
      $('searchForm').querySelector('button').style.display = show ? 'inline' : 'none'
    }

    $('searchForm').onsubmit = async e => {
      e.preventDefault()
      const type = $('searchType').value
      const value = $('searchField').value.trim()
      if (!type || !value) return

      try {
        const data = await api(`inventory/${type}/${value}`)
        renderList(data, 'searchResults')
      } catch (err) {
        alert('Search failed: ' + err.message)
      }
    }

    $('checkLowStock').onclick = async () => {
      const warehouseName = $('lowStockWarehouse').value
      const warehouse_id = warehouseMap.get(warehouseName)
      if (!warehouse_id) return alert('Select a warehouse first.')

      try {
        const data = await api(`inventory/low-stock?warehouseId=${warehouse_id}`)
        renderList(data, 'lowStockList')
      } catch (err) {
        alert('Failed to fetch low stock items: ' + err.message)
      }
    }

    $('viewAll').onclick = async () => {
      const data = await api('inventory')
      renderList(data, 'allInventoryList')
    }

    window.updateInventoryPrompt = async (id, listId) => {
      const stock = prompt('Enter new stock:')
      if (stock === null || stock.trim() === '') return
      try {
        const updated = await api(`inventory/${id}`, 'PUT', { stock: Number(stock) })
        const fresh = await api('inventory')
        renderList(fresh, listId)
      } catch (err) {
        alert('Update failed: ' + err.message)
      }
    }

    window.deleteInventory = async (id, listId) => {
      if (!confirm('Delete this inventory item?')) return
      try {
        await api(`inventory/${id}`, 'DELETE')
        const fresh = await api('inventory')
        renderList(fresh, listId)
      } catch (err) {
        alert('Delete failed: ' + err.message)
      }
    }

    loadData()
  </script>
</body>
</html>

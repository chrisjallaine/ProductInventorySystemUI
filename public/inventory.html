<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/inventory.css" />
</head>
<body>
  <header>
    <a href="index.html" class="back-link">← Dashboard</a>
    <h1>Inventory Management</h1>
  </header>

  <main class="main-container">
    <!-- Left Panel -->
<div class="left-panel">
  <!-- LOW STOCK - Added tight-section class -->
  <section class="list-section tight-section">
    <h2>Low Stock Items</h2>
    <div class="filter-group">
      <select id="lowStockWarehouse"><option value="">Select warehouse</option></select>
      <button type="button" class="button-primary" onclick="fetchLowStock()">Check Low Stock</button>
    </div>
    <!-- Added no-gap class to these elements -->
    <div id="lowStockStatus" class="status-message no-gap"></div>
    <ul id="lowStockList" class="no-gap"></ul>
  </section>
  
  <!-- SEARCH FORM - Added tight-section class -->
  <section class="form-section tight-section no-gap">
    <h2>Search Inventory</h2>
    <form id="searchForm">
      <select id="searchType" required>
        <option value="" disabled selected hidden>Search Type</option>
        <option value="product_name">Product Name</option>
        <option value="product_category">Category</option>
        <option value="product_supplier">Supplier</option>
        <option value="warehouse_name">Warehouse Name</option>
      </select>
      <input type="text" id="searchValue" placeholder="Enter value..." required />
      <button type="submit">Search</button>
    </form>
    <div id="searchStatus" class="status-message"></div>
    <ul id="searchResults"></ul>
  </section>
</div>

    <!-- Center Panel -->
    <div class="center-panel">
      <!-- ADD FORM -->
      <section class="form-section">
        <h2>Add Inventory</h2>
        <form id="addForm">
          <div class="form-group">
            <label for="productSelect">Product</label>
            <select id="productSelect" required><option value="">Select a product</option></select>
          </div>
          <div class="form-group">
            <label for="categorySelect">Category</label>
            <select id="categorySelect" required><option value="">Select a category</option></select>
          </div>
          <div class="form-group">
            <label for="supplierSelect">Supplier</label>
            <select id="supplierSelect" required><option value="">Select a supplier</option></select>
          </div>
          <div class="form-group">
            <label for="warehouseSelect">Warehouse</label>
            <select id="warehouseSelect" required><option value="">Select a warehouse</option></select>
          </div>
          <div class="form-group">
            <label for="stock">Stock Quantity</label>
            <input type="number" id="stock" min="0" value="0" required />
          </div>
          <button type="submit">Add Inventory</button>
          <div id="formStatus" class="status-message"></div>
        </form>
      </section>
    </div>

    <!-- Right Panel -->
    <div class="right-panel">
      <!-- ALL INVENTORY -->
      <section class="list-section">
        <h2>All Inventory</h2>
        <button type="button" class="button-primary" onclick="fetchInventory()">Refresh List</button>
        <ul id="inventoryList"></ul>
      </section>
    </div>
  </main>

  <!-- MODAL -->
  <div class="modal" id="updateModal">
    <div class="modal-content">
      <button class="close-btn" onclick="hideModal()">×</button>
      <h2>Update Inventory</h2>
      <form id="updateForm">
        <input type="hidden" id="updateId" />

        <div class="form-group">
          <label for="updateProduct">Product:</label>
          <select id="updateProduct" required></select>
        </div>

        <div class="form-group">
          <label for="updateCategory">Category:</label>
          <select id="updateCategory" required></select>
        </div>

        <div class="form-group">
          <label for="updateSupplier">Supplier:</label>
          <select id="updateSupplier" required></select>
        </div>

        <div class="form-group">
          <label for="updateWarehouse">Warehouse:</label>
          <select id="updateWarehouse" required></select>
        </div>

        <div class="form-group">
          <label for="updateStock">Stock Quantity:</label>
          <input type="number" id="updateStock" required />
        </div>

        <button type="submit">Save Changes</button>
      </form>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id)
    const updateModal = $('updateModal')
    const searchForm = $('searchForm')
    let latestSearch = null

    const api = async (url, method = 'GET', body) => {
      try {
        const res = await fetch(`http://localhost:5000/api/${url}`, {
          method,
          headers: body ? { 'Content-Type': 'application/json' } : {},
          body: body ? JSON.stringify(body) : undefined
        })
        if (!res.ok) {
          const errorData = await res.json()
          throw new Error(errorData.error || 'Request failed')
        }
        return await res.json()
      } catch (error) {
        console.error('API Error:', error)
        throw error
      }
    }

    const showMessage = (el, message, isError = false) => {
      el.textContent = message
      el.className = 'status-message' + (isError ? ' error' : '')
    }

    const renderOptions = (selectId, items, labelField = 'name', valueField = '_id') => {
      const select = $(selectId)
      items.forEach(item => {
        const option = document.createElement('option')
        option.value = item[valueField]
        option.textContent = item[labelField]
        select.appendChild(option)
      })
    }

    const loadDropdowns = async () => {
      try {
        const [warehouses, categories, suppliers, products] = await Promise.all([
          api('warehouses'),
          api('categories'),
          api('suppliers'),
          api('products')
        ])

        renderOptions('warehouseSelect', warehouses)
        renderOptions('lowStockWarehouse', warehouses)
        renderOptions('categorySelect', categories)
        renderOptions('supplierSelect', suppliers)
        renderOptions('productSelect', products)

      } catch (error) {
        console.error('Dropdown load error:', error)
      }
    }

    async function populateDropdowns() {
      const [products, categories, suppliers, warehouses] = await Promise.all([
        fetch('http://localhost:5000/api/products').then(res => res.json()),
        fetch('http://localhost:5000/api/categories').then(res => res.json()),
        fetch('http://localhost:5000/api/suppliers').then(res => res.json()),
        fetch('http://localhost:5000/api/warehouses').then(res => res.json())
      ])

      populateSelect('updateProduct', products, 'name')
      populateSelect('updateCategory', categories, 'name')
      populateSelect('updateSupplier', suppliers, 'name')
      populateSelect('updateWarehouse', warehouses, 'location') // or .name, depending on your schema
    }

    function populateSelect(selectId, data, labelKey) {
      const select = document.getElementById(selectId)
      select.innerHTML = data.map(item => `<option value="${item._id}">${item[labelKey]}</option>`).join('')
    }

    
    const fetchInventory = async () => {
      const res = await fetch('http://localhost:5000/api/inventory')
      const data = await res.json()
      renderList(data, 'inventoryList')
    }

    const fetchLowStock = async () => {
      const id = $('lowStockWarehouse').value
      if (!id) return showMessage($('lowStockStatus'), 'Select a warehouse first', true)
      try {
        const data = await api(`inventory/low-stock?warehouseId=${id}`)
        renderList(data, 'lowStockList', $('lowStockStatus'))
      } catch (error) {
        showMessage($('lowStockStatus'), `Failed to load: ${error.message}`, true)
      }
    }

    const openUpdateModal = async (i) => {
      await populateDropdowns() // Load dropdowns before setting selected values

      $('updateId').value = i._id
      $('updateProduct').value = i.product_id?._id || i.product_id
      $('updateCategory').value = i.category_id?._id || i.category_id
      $('updateSupplier').value = i.supplier_id?._id || i.supplier_id
      $('updateWarehouse').value = i.warehouse_id?._id || i.warehouse_id
      $('updateStock').value = i.stock

      updateModal.style.display = 'flex'
    }

    const hideModal = () => {
      updateModal.style.display = 'none'
    }

    $('addForm').addEventListener('submit', async e => {
      e.preventDefault();
      const productId = $('productSelect').value;
      const categoryId = $('categorySelect').value;
      const supplierId = $('supplierSelect').value;
      const warehouseId = $('warehouseSelect').value;
      const stockQty = Number($('stock').value);

      if (!productId || !categoryId || !supplierId || !warehouseId || isNaN(stockQty)) {
        return showMessage($('formStatus'), 'All fields are required', true);
      }

      try {
        // Always create a new inventory record
        await api('inventory', 'POST', {
          product_id: productId,
          category_id: categoryId,
          supplier_id: supplierId,
          warehouse_id: warehouseId,
          stock: stockQty
        });

        showMessage($('formStatus'), 'Inventory successfully saved!', false);
        $('addForm').reset();
        fetchInventory();
        refreshSearch();
      } catch (err) {
        console.error('Add inventory error:', err);
        showMessage($('formStatus'), `Error: ${err.message}`, true);
      }
    });

    document.getElementById('updateForm').addEventListener('submit', async e => {
      e.preventDefault()

      const id = $('updateId').value
      const updatedData = {
        product_id: $('updateProduct').value,
        category_id: $('updateCategory').value,
        supplier_id: $('updateSupplier').value,
        warehouse_id: $('updateWarehouse').value,
        stock: parseInt($('updateStock').value, 10)
      }

      try {
        const res = await fetch(`http://localhost:5000/api/inventory/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedData)
        })

        if (!res.ok) throw new Error('Update failed')

        hideModal()
        showMessage($('searchStatus'), 'Inventory updated successfully', false)

        // ✅ Refresh inventory display
        if (latestSearch?.type && latestSearch?.value) {
          // Re-run the previous search
          document.getElementById('searchForm').dispatchEvent(new Event('submit'))
        } else {
          // Or fetch full inventory again
          fetchInventory()
        }

        // ✅ Optionally refresh warehouse utilization too
        updateWarehouseUtilization()

      } catch (err) {
        console.error(err)
        showMessage($('searchStatus'), 'Error updating inventory', true)
      }
    })

    const deleteInventory = async id => {
      if (!confirm('Delete this inventory?')) return
      await fetch(`http://localhost:5000/api/inventory/${id}`, {
        method: 'DELETE'
      })
      alert('Deleted.')
      fetchInventory()
      refreshSearch()
    }

    const renderList = (data, targetId, statusElement) => {
      const listElement = $(targetId)
      if (!data.length) {
        if (statusElement) 
        listElement.innerHTML = '<p class="message-text">No inventory found</p>'
        return
      }

      const html = data.map(i => {
        const productName = i.product_id?.name || 'Unknown'
        const category = i.category_id?.name || ''
        const supplier = i.supplier_id?.name || ''
        const warehouse = i.warehouse_id?.name || ''
        const lastUpdated = new Date(i.updatedAt || i.createdAt).toLocaleString()
        return `
          <li class="card">
            <div class="card-content">
              <div><strong>Product:</strong> ${productName}</div>
              <div><strong>Category:</strong> ${category}</div>
              <div><strong>Supplier:</strong> ${supplier}</div>
              <div><strong>Warehouse:</strong> ${warehouse}</div>
              <div><strong>Stock:</strong> ${i.stock}</div>
              <div><strong>Last Updated:</strong> ${lastUpdated}</div>
            </div>
            <div class="card-actions">
              <button class="btn btn-update" onclick='openUpdateModal(${JSON.stringify(i)})'>Update</button>
              <button class="btn btn-delete" onclick="deleteInventory('${i._id}')">Delete</button>
            </div>
          </li>
        `
      }).join('')
      listElement.innerHTML = html
    }

    searchForm.addEventListener('submit', async e => {
      e.preventDefault();

      const type = $('searchType').value;
      const value = $('searchValue').value.trim();
      if (!type || !value) return;

      latestSearch = { type, value };

      try {
        const res = await fetch(`http://localhost:5000/api/inventory/search?type=${type}&value=${encodeURIComponent(value)}`, {
          cache: 'no-store'
        });

        console.log('Search response status:', res.status);

        if (res.status === 200) {
          const data = await res.json();
          console.log('Search response data:', data);

          const listElement = $('searchResults');

          if (data.length === 0) {
            listElement.innerHTML = '<p class="message-text">No inventory found</p>';
          } else {
            fetchInventory(data);
            renderList(Array.isArray(data) ? data : [data], 'searchResults');
          }
        } else {
          showMessage($('searchStatus'), `Unexpected response (status ${res.status})`, true);
        }
      } catch (error) {
        console.error('Search error:', error);
        showMessage($('searchStatus'), 'An error occurred during search.', true);
      }
    });

    const refreshSearch = () => {
      if (!latestSearch) return
      const event = new Event('submit')
      searchForm.dispatchEvent(event)
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadDropdowns()
      fetchInventory()
    })
  </script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/inventory.css" />
</head>
<body>
  <header>
    <a href="index.html" class="back-link">‚Üê Dashboard</a>
    <h1>Inventory Management</h1>
  </header>

  <main>
    <section class="form-section">
      <h2>Search Inventory</h2>
      <form id="searchForm">
        <select id="searchType" required>
          <option value="">--Select Search Type--</option>
          <option value="product_name">Product Name</option>
          <option value="product_category">Category</option>
          <option value="product_supplier">Supplier</option>
          <option value="warehouse_name">Warehouse Name</option>
        </select>
        <input type="text" id="searchField" placeholder="Enter search value" style="display: none;" required />
        <button type="submit" style="display: none;">Search</button>
      </form>
      <ul id="searchResults"></ul>
    </section>

    <section class="form-section">
      <h2>Add Inventory</h2>
      <form id="addForm">
        <label for="productSelect">Product</label>
        <select id="productSelect" required>
          <option value="">Select a product</option>
        </select>

        <div class="info-fields" style="margin: 10px 0;">
          <label for="categoryField">Category</label>
          <input type="text" id="categoryField" placeholder="Category" readonly />

          <label for="supplierField">Supplier</label>
          <input type="text" id="supplierField" placeholder="Supplier" readonly />
        </div>

        <label for="warehouseSelect">Warehouse</label>
        <select id="warehouseSelect" required>
          <option value="">Select a warehouse</option>
        </select>

        <label for="stock">Stock Quantity</label>
        <input type="number" id="stock" placeholder="Enter stock quantity" required />

        <button type="submit">Add Inventory</button>
      </form>
    </section>

    <section class="list-section">
      <h2>Low Stock Items</h2>
      <select id="lowStockWarehouse">
        <option value="">Select warehouse</option>
      </select>
      <button id="checkLowStock">Check Low Stock</button>
      <ul id="lowStockList"></ul>
    </section>

    <section class="list-section">
      <h2>All Inventory</h2>
      <button id="viewAll">Load All Inventory</button>
      <ul id="allInventoryList"></ul>
    </section>
  </main>

  <script>
    const $ = id => document.getElementById(id)

    const api = async (url, method = 'GET', body) => {
      const res = await fetch(`http://localhost:5000/api/${url}`, {
        method,
        headers: body ? { 'Content-Type': 'application/json' } : {},
        body: body ? JSON.stringify(body) : undefined
      })
      return res.json()
    }

    const populateSelect = async (url, selectId, valueKey, textKey) => {
      const data = await api(url)
      const select = $(selectId)
      data.forEach(d => {
        const opt = document.createElement('option')
        opt.value = d[valueKey]
        opt.textContent = d[textKey]
        select.appendChild(opt)
      })
    }

    const renderList = (data, targetId) => {
      $(targetId).innerHTML = data.map(i => `
        <li>
          <strong>${i.product_id?.name || 'Unknown'}</strong><br/>
          Category: ${i.category_id?.name || ''}<br/>
          Supplier: ${i.supplier_id?.name || ''}<br/>
          Stock: ${i.stock}<br/>
          Unit Price: ${i.unitPrice ? i.unitPrice.toFixed(2) : ''}<br/>
          Warehouse: ${i.warehouse_id?.location || ''}<br/>
          Last Updated: ${new Date(i.updatedAt || i.createdAt).toLocaleString()}<br/>
          <button onclick="updateInventoryPrompt('${i._id}', '${targetId}')">Update</button>
          <button onclick="deleteInventory('${i._id}', '${targetId}')">Delete</button>
        </li>
      `).join('')
    }

    window.deleteInventory = async (id, listId) => {
      if (confirm('Delete this inventory item?')) {
        await api(`inventory/${id}`, 'DELETE')
        document.querySelector(`#${listId} li button[onclick*="${id}"]`).parentElement.remove()
      }
    }

    window.updateInventoryPrompt = async (id, listId) => {
      const stock = prompt('Enter new stock (leave blank to skip):')
      const payload = {}
      if (stock !== '' && stock !== null) payload.stock = +stock
      if (!Object.keys(payload).length) return
      await api(`inventory/${id}`, 'PUT', payload)
      const data = await api('inventory')
      renderList(data, listId)
    }

    $('searchType').onchange = e => {
      $('searchField').style.display = e.target.value ? 'inline' : 'none'
      $('searchForm').querySelector('button').style.display = e.target.value ? 'inline' : 'none'
    }

    $('searchForm').onsubmit = async e => {
      e.preventDefault()
      const type = $('searchType').value
      const value = $('searchField').value.trim()
      if (!type || !value) return
      const data = await api(`inventory/${type.replace('_', '-')}/${value}`)
      renderList(data, 'searchResults')
    }

    $('addForm').onsubmit = async e => {
      e.preventDefault()
      const payload = {
        product_id: $('productSelect').value,
        warehouse_id: $('warehouseSelect').value,
        stock: +$('stock').value
      }
      await api('inventory', 'POST', payload)
      alert('Inventory added.')
      $('addForm').reset()
      $('categoryField').value = ''
      $('supplierField').value = ''
    }

    $('checkLowStock').onclick = async () => {
      const id = $('lowStockWarehouse').value
      if (!id) return alert('Select a warehouse first.')
      const data = await api(`inventory/low-stock?warehouseId=${id}`)
      renderList(data, 'lowStockList')
    }

    $('viewAll').onclick = async () => {
      const data = await api('inventory')
      renderList(data, 'allInventoryList')
    }

    $('productSelect').onchange = async () => {
      const productId = $('productSelect').value
      if (!productId) {
        $('categoryField').value = ''
        $('supplierField').value = ''
        return
      }
      const product = await api(`products/${productId}`)
      $('categoryField').value = product.category_id?.name || ''
      $('supplierField').value = product.supplier_id?.name || ''
    }

    populateSelect('products', 'productSelect', '_id', 'name')
    populateSelect('warehouses', 'warehouseSelect', '_id', 'location')
    populateSelect('warehouses', 'lowStockWarehouse', '_id', 'location')
  </script>
</body>
</html>

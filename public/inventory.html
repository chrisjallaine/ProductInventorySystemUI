<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Inventory - Whiplash</title>
  <link rel="stylesheet" href="css/inventory.css" />
</head>
<body>
  <header>
    <a href="index.html" class="back-link">‚Üê Dashboard</a>
    <h1>Inventory Management</h1>
  </header>

  <main>
    <section class="form-section">
      <h2>Search Inventory</h2>

      <form id="searchForm">
        <label for="searchType">Search By:</label>
        <select id="searchType" name="searchType" required>
          <option value="">--Select Search Type--</option>
          <option value="product_name">Product Name</option>
          <option value="product_category">Category</option>
          <option value="product_supplier">Supplier</option>
          <option value="warehouse_name">Warehouse Name</option>
        </select>

        <input type="text" id="searchField" name="searchField" placeholder="Enter search value" style="display:none;" required />
        <button type="submit" style="display:none;">Search</button>
      </form>
      <ul id="searchResults"></ul>
    </section>

    <section class="form-section">
      <h2>Add Inventory Entry</h2>
      <form id="addInventoryForm">
        <label>Product:</label>
        <select name="product_id" id="productSelect" required></select>

        <label>Warehouse:</label>
        <select name="warehouse_id" id="warehouseSelect" required></select>

        <input type="number" name="stock" placeholder="Stock" required />
        <input type="number" name="unitPrice" placeholder="Unit Price" required />
        <input type="date" name="expiryDate" />
        <button type="submit">Add Inventory</button>
      </form>
    </section>

    <section class="list-section">
      <h2>Low Stock Items</h2>
      <button onclick="fetchLowStock()">Check Low Stock</button>
      <ul id="lowStockList"></ul>
    </section>
  </main>

  <script>
    // Update search field visibility based on the selected search type
    document.getElementById("searchType").addEventListener("change", function(e) {
      const searchType = e.target.value;
      const searchField = document.getElementById("searchField");
      const searchButton = document.querySelector("form button");

      if (searchType) {
        searchField.style.display = "inline";
        searchButton.style.display = "inline";
        searchField.placeholder = `Enter ${searchType}`;
      } else {
        searchField.style.display = "none";
        searchButton.style.display = "none";
      }
    });

    // Function to fetch results for Product Name search
    async function fetchByProductName(productName) {
      const res = await fetch(`http://localhost:5000/api/inventory/product-name/${productName}`);
      const data = await res.json();
      return data;
    }

    // Function to fetch results for Product Category search
    async function fetchByCategory(category) {
      const res = await fetch(`http://localhost:5000/api/inventory/product-category/${category}`);
      const data = await res.json();
      return data;
    }

    // Function to fetch results for Product Supplier search
    async function fetchBySupplier(supplier) {
      const res = await fetch(`http://localhost:5000/api/inventory/product-supplier/${supplier}`);
      const data = await res.json();
      return data;
    }

    // Function to fetch results for Warehouse Name search
    async function fetchByWarehouse(warehouse) {
      const res = await fetch(`http://localhost:5000/api/inventory/warehouse-name/${warehouse}`);
      const data = await res.json();
      return data;
    }

    // Delete inventory item
    async function deleteInventory(id) {
      const res = await fetch(`http://localhost:5000/api/inventory/${id}`, {
        method: 'DELETE',
      });

      if (res.ok) {
        alert("Item deleted successfully!");
        // Remove the item from the displayed list
        document.querySelector(`#result-${id}`).remove();
      } else {
        alert("Failed to delete item.");
      }
    }

    // Search form submit handler
    document.getElementById("searchForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const searchType = document.getElementById("searchType").value;
      const searchField = document.getElementById("searchField").value.trim();

      if (!searchType || !searchField) return;

      let results = [];
      switch (searchType) {
        case "product_name":
          results = await fetchByProductName(searchField);
          break;
        case "product_category":
          results = await fetchByCategory(searchField);
          break;
        case "product_supplier":
          results = await fetchBySupplier(searchField);
          break;
        case "warehouse_name":
          results = await fetchByWarehouse(searchField);
          break;
      }

      const resultsList = document.getElementById("searchResults");
      resultsList.innerHTML = results.map(item => {
        const productName = item.product_id ? item.product_id.name : "N/A";
        const stock = item.stock || "N/A";
        const warehouseLocation = item.warehouse_id ? item.warehouse_id.location : "N/A";
        return `
          <li id="result-${item._id}">
            <strong>Product:</strong> ${productName} <br>
            <strong>Stock:</strong> ${stock} <br>
            <strong>Warehouse:</strong> ${warehouseLocation} <br>
            <button onclick="deleteInventory('${item._id}')">Delete</button>
          </li>
        `;
      }).join('');
    });

    // Fetch products and warehouses for inventory addition
    async function fetchProducts() {
      const res = await fetch("http://localhost:5000/api/products");
      const data = await res.json();
      const select = document.getElementById("productSelect");
      select.innerHTML = "";
      data.forEach(p => {
        const option = document.createElement("option");
        option.value = p._id;
        option.textContent = p.name;
        select.appendChild(option);
      });
    }

    async function fetchWarehouses() {
      const res = await fetch("http://localhost:5000/api/warehouses");
      const data = await res.json();
      const select = document.getElementById("warehouseSelect");
      select.innerHTML = "";
      data.forEach(w => {
        const option = document.createElement("option");
        option.value = w._id;
        option.textContent = w.location;
        select.appendChild(option);
      });
    }

    // Fetch low stock items
    async function fetchLowStock() {
      try {
        const res = await fetch("http://localhost:5000/api/inventory/low-stock");
        
        if (!res.ok) {
          throw new Error("Failed to fetch low stock items.");
        }

        const data = await res.json();
        const list = document.getElementById("lowStockList");
        list.innerHTML = "";

        if (data.length === 0) {
          list.innerHTML = "<li>No low stock items found.</li>";
          return;
        }

        data.forEach(i => {
          const li = document.createElement("li");
          li.innerHTML = ` 
            <strong>${i.product_id.name}</strong><br>
            Stock: ${i.stock} | Warehouse: ${i.warehouse_id.location}<br>
            <button onclick="deleteInventory('${i._id}')">Delete</button>
          `;
          list.appendChild(li);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // Call the fetch functions to populate products and warehouses
    fetchProducts();
    fetchWarehouses();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/inventory.css" />
  <style>
    .loading { opacity: 0.5; pointer-events: none; }
    .error-message { color: #dc3545; margin: 5px 0; }
    .success-message { color: #28a745; margin: 5px 0; }
  </style>
</head>
<body>
  <header>
    <a href="index.html" class="back-link">‚Üê Dashboard</a>
    <h1>Inventory Management</h1>
  </header>

  <main>
    <section class="form-section">
      <h2>Search Inventory</h2>
      <form id="searchForm">
        <select id="searchType" required>
          <option value="">--Select Search Type--</option>
          <option value="product_name">Product Name</option>
          <option value="product_category">Category</option>
          <option value="product_supplier">Supplier</option>
          <option value="warehouse_name">Warehouse Name</option>
        </select>
        <input type="text" id="searchField" placeholder="Enter search value" style="display: none;" required />
        <button type="submit" style="display: none;">Search</button>
      </form>
      <div id="searchStatus" class="status-message"></div>
      <ul id="searchResults"></ul>
    </section>

    <section class="form-section">
      <h2>Add Inventory</h2>
      <form id="addForm">
        <div class="form-group">
          <label for="productSelect">Product</label>
          <select id="productSelect" required>
            <option value="">Select a product</option>
          </select>
        </div>

        <div class="info-fields">
          <div class="form-group">
            <label for="categoryField">Category</label>
            <input type="text" id="categoryField" readonly />
          </div>
          <div class="form-group">
            <label for="supplierField">Supplier</label>
            <input type="text" id="supplierField" readonly />
          </div>
        </div>

        <div class="form-group">
          <label for="warehouseSelect">Warehouse</label>
          <select id="warehouseSelect" required>
            <option value="">Select a warehouse</option>
          </select>
        </div>

        <div class="form-group">
          <label for="stock">Stock Quantity</label>
          <input type="number" id="stock" min="0" required />
        </div>

        <button type="submit" id="submitBtn">Add Inventory</button>
        <div id="formStatus" class="status-message"></div>
      </form>
    </section>

    <section class="list-section">
      <h2>Low Stock Items</h2>
      <div class="filter-group">
        <select id="lowStockWarehouse">
          <option value="">Select warehouse</option>
        </select>
        <button id="checkLowStock">Check Low Stock</button>
      </div>
      <div id="lowStockStatus" class="status-message"></div>
      <ul id="lowStockList"></ul>
    </section>

    <section class="list-section">
      <h2>All Inventory</h2>
      <button id="viewAll">Load All Inventory</button>
      <div id="allInventoryStatus" class="status-message"></div>
      <ul id="allInventoryList"></ul>
    </section>
  </main>

  <script>
    const $ = id => document.getElementById(id)
    let isLoading = false

    const api = async (url, method = 'GET', body) => {
      try {
        const res = await fetch(`http://localhost:5000/api/${url}`, {
          method,
          headers: body ? { 'Content-Type': 'application/json' } : {},
          body: body ? JSON.stringify(body) : undefined
        })
        if (!res.ok) {
          const errorData = await res.json()
          throw new Error(errorData.error || 'Request failed')
        }
        return await res.json()
      } catch (error) {
        console.error('API Error:', error)
        throw error
      }
    }

    const showMessage = (element, message, isError = true) => {
      element.textContent = message
      element.className = `status-message ${isError ? 'error-message' : 'success-message'}`
      setTimeout(() => element.textContent = '', 3000)
    }

    const setLoading = (state) => {
      isLoading = state
      document.body.classList.toggle('loading', state)
    }

    const renderList = (data, targetId, statusElement) => {
      const listElement = $(targetId)
      if (!data.length) {
        statusElement && showMessage(statusElement, 'No items found', false)
        listElement.innerHTML = '<li>No items found</li>'
        return
      }
      listElement.innerHTML = data.map(i => `
        <li>
          <strong>${i.product_id?.name || 'Unknown'}</strong><br/>
          Category: ${i.category_id?.name || ''}<br/>
          Supplier: ${i.supplier_id?.name || ''}<br/>
          Stock: ${i.stock}<br/>
          Warehouse: ${i.warehouse_id?.location || ''}<br/>
          Last Updated: ${new Date(i.updatedAt || i.createdAt).toLocaleString()}<br/>
          <div class="item-actions">
            <button onclick="updateInventoryPrompt('${i._id}', '${targetId}')">Update</button>
            <button class="delete-btn" onclick="deleteInventory('${i._id}', '${targetId}')">Delete</button>
          </div>
        </li>
      `).join('')
    }

    window.deleteInventory = async (id, listId) => {
      if (!confirm('Delete this inventory item?')) return
      try {
        setLoading(true)
        await api(`inventory/${id}`, 'DELETE')
        $(listId).querySelector(`li button[onclick*="${id}"]`).closest('li').remove()
      } catch (error) {
        showMessage($('allInventoryStatus'), `Delete failed: ${error.message}`)
      } finally {
        setLoading(false)
      }
    }

    window.updateInventoryPrompt = async (id, listId) => {
      const stock = prompt('Enter new stock quantity:')
      if (stock === null || stock.trim() === '') return
      try {
        setLoading(true)
        await api(`inventory/${id}`, 'PUT', { stock: Number(stock) })
        const data = await api('inventory')
        renderList(data, listId, $('allInventoryStatus'))
      } catch (error) {
        showMessage($('allInventoryStatus'), `Update failed: ${error.message}`)
      } finally {
        setLoading(false)
      }
    }

    $('searchType').onchange = e => {
      const field = $('searchField')
      const button = $('searchForm').querySelector('button')
      const val = e.target.value
      field.style.display = button.style.display = val ? 'inline' : 'none'
      if (val) {
        const text = e.target.options[e.target.selectedIndex].text
        field.placeholder = `Enter ${text}`
      }
    }

    $('searchForm').onsubmit = async e => {
      e.preventDefault()
      const type = $('searchType').value
      const value = $('searchField').value.trim()
      if (!type || !value) return
      const endpointMap = {
        product_name: 'product', // Ensure this maps to the correct API endpoint
        product_category: 'category',
        product_supplier: 'supplier',
        warehouse_name: 'warehouse' // Ensure this maps to the correct API endpoint
      }
      const endpoint = endpointMap[type]
      if (!endpoint) return showMessage($('searchStatus'), 'Invalid search type', true)
      try {
        setLoading(true)
        const data = await api(`inventory/${endpoint}/${value}`) // Ensure this API call is correct
        renderList(data, 'searchResults', $('searchStatus'))
      } catch (error) {
        showMessage($('searchStatus'), `Search failed: ${error.message}`)
      } finally {
        setLoading(false)
      }
    }

    $('addForm').addEventListener('submit', async e => {
      e.preventDefault()
      const productId   = $('productSelect').value
      const warehouseId = $('warehouseSelect').value
      const stockQty    = Number($('stock').value)

      if (!productId || !warehouseId || isNaN(stockQty)) {
        return showMessage($('formStatus'), 'All fields are required', true)
      }

      const formData = {
        product_id: productId.toString(),
        warehouse_id: warehouseId.toString(),
        stock: stockQty
      }
      console.log('Submitting inventory:', formData)

      try {
        setLoading(true)
        await api('inventory', 'POST', formData)
        showMessage($('formStatus'), 'Inventory added successfully!', false)
        $('addForm').reset()
        $('categoryField').value = ''
        $('supplierField').value = ''
        const allData = await api('inventory')
        renderList(allData, 'allInventoryList', $('allInventoryStatus'))
      } catch (err) {
        console.error('Add inventory error:', err)
        showMessage($('formStatus'), `Add failed: ${err.message}`, true)
      } finally {
        setLoading(false)
      }
    })

    $('checkLowStock').onclick = async () => {
      const id = $('lowStockWarehouse').value
      if (!id) return showMessage($('lowStockStatus'), 'Select a warehouse first', true)
      try {
        setLoading(true)
        const data = await api(`inventory/low-stock?warehouseId=${id}`)
        renderList(data, 'lowStockList', $('lowStockStatus'))
      } catch (error) {
        showMessage($('lowStockStatus'), `Failed to load: ${error.message}`, true)
      } finally {
        setLoading(false)
      }
    }

    $('viewAll').onclick = async () => {
      try {
        setLoading(true)
        const data = await api('inventory')
        renderList(data, 'allInventoryList', $('allInventoryStatus'))
      } catch (error) {
        showMessage($('allInventoryStatus'), `Failed to load: ${error.message}`, true)
      } finally {
        setLoading(false)
      }
    }

    $('productSelect').onchange = async () => {
      const productId = $('productSelect').value
      if (!productId) {
        $('categoryField').value = ''
        $('supplierField').value = ''
        return
      }
      try {
        const product = await api(`products/${productId}`)
        $('categoryField').value = product.category_id?.name || ''
        $('supplierField').value = product.supplier_id?.name || ''
      } catch (error) {
        console.error('Failed to fetch product details:', error)
      }
    }

    const populateSelect = async (url, selectId, valueKey, textKey) => {
      try {
        const data = await api(url)
        const select = $(selectId)
        select.innerHTML = `<option value="">${selectId === 'productSelect' ? 'Select a product' : 'Select a warehouse'}</option>`
        data.forEach(d => {
          const opt = document.createElement('option')
          opt.value = d[valueKey]
          opt.textContent = d[textKey]
          select.appendChild(opt)
        })
      } catch (error) {
        console.error(`Failed to populate ${selectId}:`, error)
      }
    }

    ;(async () => {
      try {
        setLoading(true)
        await Promise.all([
          populateSelect('products', 'productSelect', '_id', 'name'),
          populateSelect('warehouses', 'warehouseSelect', '_id', 'location'),
          populateSelect('warehouses', 'lowStockWarehouse', '_id', 'location')
        ])
        const data = await api('inventory')
        renderList(data, 'allInventoryList', $('allInventoryStatus'))
      } catch (error) {
        console.error('Initialization error:', error)
      } finally {
        setLoading(false)
      }
    })()
  </script>
</body>
</html>
